name: Deploy to AWS (Dev)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ V√©rifier et r√©cup√©rer le code source
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Installer le client SSH
      - name: Install SSH client
        run: sudo apt-get update && sudo apt-get install -y openssh-client

      # 3Ô∏è‚É£ Configurer la cl√© SSH
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      # 4Ô∏è‚É£ Tester la connexion SSH
      - name: Test SSH Connection
        run: ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "echo ‚úÖ Connexion SSH r√©ussie !"

      # 5Ô∏è‚É£ D√©ployer l'application sur AWS
      - name: Deploy to AWS
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} <<EOF
            set -e  # Stopper l'ex√©cution en cas d'erreur

            echo "üìÇ D√©placement vers le r√©pertoire de travail..."
            cd ${{ secrets.WORK_DIR }}

            # V√©rifier qu'on est bien dans le bon r√©pertoire
            pwd
            ls -la

            echo "üîÑ Passage sur la branche main et pull du projet..."
            git checkout main
            git pull origin main

            # V√©rifier la pr√©sence du fichier docker-compose.yml
            if [ ! -f "docker-compose.yml" ]; then
              echo "‚ùå Erreur : Fichier docker-compose.yml introuvable."
              exit 1
            fi

            echo "üõë Arr√™t et suppression des anciens conteneurs..."
            docker-compose down

            echo "üßπ Nettoyage des anciens conteneurs et images..."
            docker system prune -af

            echo "üöÄ Reconstruction et d√©marrage des nouveaux conteneurs..."
            docker-compose up --build -d

            echo "‚úÖ D√©ploiement termin√© avec succ√®s !"
          EOF

      # 6Ô∏è‚É£ Nettoyage des cl√©s SSH pour la s√©curit√©
      - name: Clean up SSH key
        run: rm -rf ~/.ssh



