name: Deploy to AWS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ V√©rifier le code source
      - name: Checkout repository
        uses: actions/checkout@v3

      # Demande avant mise √† jour des paquets
      - name: Confirm package update and OpenSSH installation
        run: echo "‚ö†Ô∏è Pr√™t √† mettre √† jour les paquets et installer OpenSSH ? (Oui/Non)"

      # 2Ô∏è‚É£ Mettre √† jour les paquets et installer OpenSSH
      - name: Update packages and install OpenSSH
        run: sudo apt-get update && sudo apt-get install -y openssh-client

      # Demande avant configuration de la cl√© SSH
      - name: Confirm SSH Key setup
        run: echo "‚ö†Ô∏è Pr√™t √† configurer la cl√© SSH ? (Oui/Non)"

      # 3Ô∏è‚É£ Cr√©er le r√©pertoire .ssh et ajouter la cl√© priv√©e
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | base64 --decode > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      # Demande avant d√©ploiement
      - name: Confirm AWS deployment
        run: echo "‚ö†Ô∏è Pr√™t √† arr√™ter, supprimer et red√©ployer le conteneur ? (Oui/Non)"

      # 4Ô∏è‚É£ Se connecter au serveur AWS et effectuer le d√©ploiement
      - name: Deploy application
        run: |
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            cd ${{ secrets.WORK_DIR }}

            # Down le conteneur Docker
            echo "üõë Arr√™t du conteneur Docker..."
            docker compose down || docker stop mon_conteneur && docker rm mon_conteneur

            # Supprimer l'image Docker
            echo "üóë Suppression de l'image Docker..."
            docker rmi mon_image || echo "Aucune image √† supprimer"

            # Pull la derni√®re version du projet
            echo "üîÑ Mise √† jour du projet..."
            git pull origin main

            # Rebuild et red√©marrage du conteneur
            echo "üöÄ Reconstruction et d√©marrage du conteneur..."
            docker compose up --build -d

            # Afficher les logs pour v√©rification
            echo "üìú Logs du conteneur en cours..."
            docker logs -f mon_conteneur

            exit
          EOF

      # Demande avant suppression du r√©pertoire .ssh
      - name: Confirm SSH Key cleanup
        run: echo "‚ö†Ô∏è Pr√™t √† supprimer le r√©pertoire .ssh pour la s√©curit√© ? (Oui/Non)"

      # 5Ô∏è‚É£ Supprimer le r√©pertoire .ssh pour la s√©curit√©
      - name: Cleanup SSH Keys
        run: rm -rf ~/.ssh


